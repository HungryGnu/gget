name: Backup gget Repo on Google Drive

on:
  schedule:
    - cron: "0 0 * * 0"  # Runs at midnight every Sunday
  workflow_dispatch:

jobs:
  backup:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout all branches
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch all history for all branches

      - name: Set backup filename
        run: echo "BACKUP_FILE=$(echo \"${{ github.repository }}-backup-$(date +%F).tar.gz\" | sed 's/\//-/g')" >> $GITHUB_ENV

      - name: Create backup archive
        run: |
          tar --exclude='.git' \
              --exclude='.github' \
              --exclude='credentials.json' \
              --exclude="$BACKUP_FILE" \
              --warning=no-file-changed \
              -cvzf "$BACKUP_FILE" . || [ $? -eq 1 ]

      - name: Check if backup archive exists
        run: |
          if [ -f "$BACKUP_FILE" ]; then
            echo "Backup file found: $BACKUP_FILE"
            ls -lh "$BACKUP_FILE"
          else
            echo "Backup file not found!"
            exit 1
          fi

      - name: Create credentials.json
        id: create-json
        uses: jsdaniell/create-json@v1.2.3
        with:
          name: "credentials.json"
          json: ${{ secrets.GDRIVE_BACKUP_CREDENTIALS }}

      - name: Install rclone
        run: |
          curl https://rclone.org/install.sh | sudo bash

      - name: Configure rclone
        run: |
          mkdir -p ~/.config/rclone/
          rclone config create gdrive drive \
            --config ~/.config/rclone/rclone.conf \
            service_account_file credentials.json || exit 1

      - name: Test connection and upload archive to Google Drive
        run: |
          set -e
          rclone listremotes
          rclone ls gdrive:{"15ra8gwFwa_8IZJ59wZ6iQs9mXVZrnOd"} || exit 1
          rclone copy "$BACKUP_FILE" gdrive:{"15ra8gwFwa_8IZJ59wZ6iQs9mXVZrnOd"} --verbose || exit 1

      - name: Clean up
        run: |
          rm -f "$BACKUP_FILE"
          rm -f credentials.json
